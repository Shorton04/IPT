*---------------------------------------------------------------------*
* Get first valid operation
*---------------------------------------------------------------------*
FORM f_get_operation USING ps_order TYPE viaufkst
                     CHANGING pv_vornr TYPE afvc-vornr.

  DATA: lv_aufpl TYPE afko-aufpl,
        lv_stat  TYPE jest-stat,
        pv_found TYPE abap_bool VALUE abap_false.

  " Define structure and table for operations
  TYPES: BEGIN OF ty_op,
           vornr TYPE afvc-vornr,
           objnr TYPE afvc-objnr,
         END OF ty_op.

  DATA: ls_op  TYPE ty_op,
        lt_ops TYPE TABLE OF ty_op.

  CLEAR pv_vornr.

  " 1️⃣ Get routing number for this order (AFKO)
  SELECT SINGLE aufpl
    INTO @lv_aufpl
    FROM afko
   WHERE aufnr = @ps_order-aufnr.

  IF sy-subrc <> 0 OR lv_aufpl IS INITIAL.
    RETURN. " No routing found for this order
  ENDIF.

  " 2️⃣ Get operations linked to that routing (AFVC)
  SELECT vornr, objnr
    FROM afvc
    WHERE aufpl = @lv_aufpl
    ORDER BY aplzl
    INTO TABLE @lt_ops.

  IF lt_ops IS INITIAL.
    RETURN.
  ENDIF.

  " 3️⃣ Loop and pick the first active (not deleted) operation
  LOOP AT lt_ops INTO ls_op.

    SELECT SINGLE stat
      FROM jest
     WHERE objnr = @ls_op-objnr
       AND stat  = 'I0013'  " Deleted
       AND inact = ''
     INTO @lv_stat.

    IF sy-subrc <> 0.
      pv_vornr = ls_op-vornr.
      pv_found = abap_true.
      EXIT. " Found valid operation
    ENDIF.

  ENDLOOP.

  IF pv_found = abap_false.
    pv_vornr = ''.
  ENDIF.

ENDFORM.