FORM f_get_operation USING ps_order TYPE viaufkst
                     CHANGING pv_vornr TYPE afvc-vornr.

  DATA: lt_afvc TYPE TABLE OF afvc,
        ls_afvc TYPE afvc,
        lv_stat TYPE jest-stat.

  SELECT vornr aufpl aplzl objnr
    FROM afvc
    WHERE aufpl = @ps_order-aufpl
    INTO TABLE @lt_afvc
    ORDER BY aplzl.

  LOOP AT lt_afvc INTO ls_afvc.
    " Check deletion flag (I0013)
    SELECT SINGLE stat
      INTO lv_stat
      FROM jest
      WHERE objnr = @ls_afvc-objnr
        AND stat = 'I0013'
        AND inact = ''.

    IF sy-subrc <> 0.
      pv_vornr = ls_afvc-vornr.
      EXIT. " first active operation found
    ENDIF.
  ENDLOOP.

ENDFORM.


*---------------------------------------------------------------------*
* Prepare output
*---------------------------------------------------------------------*
FORM f_prepare_output USING ps_order TYPE viaufkst
                            pv_vornr TYPE vornr
                            pv_stat  TYPE jest-stat.

  CLEAR gs_output.
  gs_output-OrderMessageStatus        = 'CREATE'.
  gs_output-Plant                     = ps_order-iwerk.
  gs_output-MaintenanceOrder          = ps_order-aufnr.
  gs_output-MaintenanceOrderOperation = pv_vornr.
  gs_output-MaintOrdBasicStartDate    = ps_order-gstrp.
  gs_output-MaintOrdBasicEndDate      = ps_order-gltrp.
  gs_output-LatestAcceptableComplDate = ps_order-lacd_date.
  gs_output-SystemId                  = sy-sysid.

  SELECT SINGLE txt04 INTO gs_output-SystemStatusText
    FROM tj02t
   WHERE istat = pv_stat
     AND spras = 'E'.

  IF ps_order-equnr IS NOT INITIAL.
    gs_output-TechnicalObject = ps_order-equnr.
  ELSE.
    gs_output-TechnicalObject = ps_order-tplnr.
  ENDIF.

  APPEND gs_output TO gt_output.

ENDFORM.